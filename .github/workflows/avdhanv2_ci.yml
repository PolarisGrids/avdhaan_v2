name: Deploy to Private OKE Cluster

on:
  push:
    branches:
      - main
      
jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      OCI_CLI_USER: ${{ secrets.OCI_CLI_USER }}
      OCI_CLI_TENANCY: ${{ secrets.OCI_CLI_TENANCY }}
      OCI_CLI_FINGERPRINT: ${{ secrets.OCI_CLI_FINGERPRINT }}
      OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_CLI_KEY_CONTENT }}
      OCI_CLI_REGION: ${{ secrets.OCI_CLI_REGION }}
      OCI_SECRET_OCID: ${{ secrets.OCI_SECRET_OCID }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up OCI CLI
      run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install oci-cli

    - name: Validate OCI CLI installation
      run: |
          oci --version

    - name: Check OCI CLI configuration
      run: |
          mkdir -p ~/.oci
          echo "[DEFAULT]" > ~/.oci/config
          echo "user=${{ secrets.OCI_CLI_USER }}" >> ~/.oci/config
          echo "fingerprint=${{ secrets.OCI_CLI_FINGERPRINT }}" >> ~/.oci/config
          echo "tenancy=${{ secrets.OCI_CLI_TENANCY }}" >> ~/.oci/config
          echo "region=${{ secrets.OCI_CLI_REGION }}" >> ~/.oci/config
          echo "key_file=~/.oci/oci_api_key.pem" >> ~/.oci/config
          echo "${{ secrets.OCI_CLI_KEY_CONTENT }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          cat ~/.oci/config
      shell: bash
    
    - name: Retrieve secrets from OCI Vault
      run: |
          oci secrets secret-bundle get --secret-id ocid1.vaultsecret.oc1.ap-mumbai-1.amaaaaaavdzcjeaapjuls266qcaqxwmbeonbxwyef7dtfrfv4fz2vzp4xsdq --query 'data."secret-bundle-content".content' --raw-output | base64 --decode > env.json
          jq -r 'to_entries | .[] | "\(.key)=\(.value|tostring)"' env.json > .env
          cat .env
          ls -a
    
    - name: Login to Oracle Cloud Infrastructure Registry (OCIR)
      run: |
        echo "${{ secrets.OCI_AUTH_TOKEN }}" | docker login -u "${{ secrets.OCI_NAMESPACE }}/${{ secrets.OCI_USER_MAIL }}" ${{ secrets.OCI_CLI_REGION }}.ocir.io --password-stdin
    
    - name: Print Docker Tag for Debugging
      run: |
        echo "OCI_CLI_REGION: '${{ secrets.OCI_CLI_REGION }}'"
        echo "OCI_NAMESPACE: '${{ secrets.OCI_NAMESPACE }}'"
        echo "NAME_REPO: '${{ secrets.NAME_REPO }}'"
        IMAGE_TAG="${{ secrets.OCI_CLI_REGION }}.ocir.io/${{ secrets.OCI_NAMESPACE }}/${{ secrets.NAME_REPO }}:latest"
        echo "Docker Image Tag: '$IMAGE_TAG'"

    - name: Build Docker image
      run: |
          IMAGE_TAG="${{ secrets.OCI_CLI_REGION }}.ocir.io/${{ secrets.OCI_NAMESPACE }}/${{ secrets.NAME_REPO }}:latest"
          echo "Building Docker image with tag '$IMAGE_TAG'..."
          docker build -t $IMAGE_TAG .
    
    - name: Push Docker Image to Oracle Cloud Registry
      run: |
        IMAGE_TAG="${{ secrets.OCI_CLI_REGION }}.ocir.io/${{ secrets.OCI_NAMESPACE }}/${{ secrets.NAME_REPO }}:latest"
        echo "Pushing Docker image with tag '$IMAGE_TAG'..."
        docker push $IMAGE_TAG
